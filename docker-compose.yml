# docker-compose.yml (最终版 - 使用环境变量注入 Authtoken)

services:
  frontend:
    build: { context: ./frontend }
    container_name: sarawak_agri_frontend
    restart: unless-stopped
    ports: ["8080:80"]

  backend:
    build: { context: . }
    container_name: sarawak_agri_backend
    restart: unless-stopped
    ports: ["8000:8000"]
    volumes: ["./app:/app/app"]
    depends_on: [db, redis, mail]
    env_file: [.env]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  db:
    image: mysql:8.0
    container_name: sarawak_agri_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    container_name: sarawak_agri_redis
    restart: unless-stopped

  mail:
    build: { context: ./mail_service }
    container_name: sarawak_agri_mail
    restart: unless-stopped

  worker:
    build: { context: . }
    container_name: sarawak_agri_worker
    command: celery -A app.background_tasks.celery_app worker --loglevel=info
    volumes: ["./app:/app/app"]
    depends_on: [redis, backend]
    restart: unless-stopped
    env_file: [.env]
    
  ngrok:
    image: ngrok/ngrok:latest
    container_name: sarawak_agri_ngrok
    restart: unless-stopped
    ports:
      - "4040:4040"
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    command: http backend:8000 --domain juliette-unattempted-tammara.ngrok-free.dev
    # --- ↓↓↓ 修改 depends_on，等待 backend 健康 ↓↓↓ ---
    depends_on:
      backend:
        condition: service_healthy

volumes:
  mysql_data:
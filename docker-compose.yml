# docker-compose.yml (调试版 - 移除了 healthcheck)

services:
  frontend:
    build: { context: ./frontend }
    container_name: sarawak_agri_frontend
    restart: unless-stopped
    ports: ["8080:80"]

  backend:
    build: { context: . }
    container_name: sarawak_agri_backend
    restart: unless-stopped
    ports: ["8000:8000"]
    volumes: ["./app:/app/app"]
    depends_on: [db, redis, mail]
    env_file: [.env]

  db:
    image: mysql:8.0
    container_name: sarawak_agri_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
    ports: ["3307:3306"]
    volumes: [mysql_data:/var/lib/mysql]

  redis:
    image: redis:7-alpine
    container_name: sarawak_agri_redis
    restart: unless-stopped

  mail:
    build: { context: ./mail_service }
    container_name: sarawak_agri_mail
    restart: unless-stopped

  worker:
    build: { context: . }
    container_name: sarawak_agri_worker
    command: celery -A app.background_tasks.celery_app worker --loglevel=info
    volumes: ["./app:/app/app"]
    depends_on: [redis, backend]
    restart: unless-stopped
    env_file: [.env]
    
  ngrok:
    image: ngrok/ngrok:latest
    container_name: sarawak_agri_ngrok
    restart: unless-stopped
    ports: ["4040:4040"]
    command: http backend:8000 --authtoken 2w4uQUFWisFpNRn7nXIuo9oJ6ks_66QJeh3V3DviwHjeSVzZ5 # 确保这里的 token 是正确的
    depends_on:
      - backend

volumes:
  mysql_data: